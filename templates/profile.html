{% extends 'base.html' %}

{% block title %}Profile — LLM Code Assist{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto w-full py-6">

  <!-- ── Page Header ─────────────────────────────────────── -->
  <div class="mb-8">
    <div class="flex items-center gap-3 mb-1">
      <a href="/" class="btn btn-ghost p-1.5 text-sm" title="Back to dashboard">
        <i class="fas fa-arrow-left"></i>
      </a>
      <h1 class="text-3xl font-bold gradient-text">Profile</h1>
    </div>
    <p class="text-secondary ml-10">Manage your account and preferences</p>
  </div>

  <!-- ── Avatar / Identity Card ─────────────────────────── -->
  <div class="card mb-6" style="padding:2rem;">
    <div class="flex flex-col sm:flex-row items-center sm:items-start gap-6">

      <!-- Avatar -->
      <div class="relative flex-shrink-0">
        <img
          id="profile-avatar"
          src="https://ui-avatars.com/api/?name=User&background=6366f1&color=fff&size=128"
          alt="Profile avatar"
          class="w-24 h-24 rounded-full object-cover"
          style="border:3px solid var(--accent);box-shadow:0 0 24px rgba(99,102,241,0.35);"
        />
        <span
          class="absolute bottom-1 right-1 w-4 h-4 rounded-full border-2"
          style="background:#22c55e;border-color:var(--bg-surface);"
          title="Online"
        ></span>
      </div>

      <!-- Info -->
      <div class="flex-1 min-w-0 text-center sm:text-left">
        <h2 id="profile-name" class="text-2xl font-bold text-primary mb-1 truncate">Loading...</h2>
        <p id="profile-email" class="text-muted mb-3 truncate">loading@example.com</p>

        <div class="flex flex-wrap items-center justify-center sm:justify-start gap-2">
          <span class="badge-indigo text-xs">
            <i class="fas fa-shield-alt mr-1"></i>Verified
          </span>
          <span class="badge-green text-xs">
            <i class="fas fa-circle mr-1" style="font-size:0.5rem;"></i>Active
          </span>
          <span
            class="text-xs px-2 py-0.5 rounded-full"
            style="background:rgba(99,102,241,0.12);color:var(--text-muted);border:1px solid rgba(99,102,241,0.2);"
          >
            <i class="fab fa-google mr-1"></i>Google OAuth
          </span>
        </div>

        <p id="profile-member-since" class="text-xs text-muted mt-3">
          <i class="fas fa-calendar-alt mr-1"></i>Member since --
        </p>
      </div>

    </div>
  </div>

  <!-- ── Stats Cards ──────────────────────────────────────── -->
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">

    <div class="stat-card text-center">
      <div class="stat-icon mx-auto mb-3"
           style="background:rgba(99,102,241,0.15);color:var(--accent-light);width:2.5rem;height:2.5rem;border-radius:0.75rem;display:flex;align-items:center;justify-content:center;">
        <i class="fas fa-folder-open"></i>
      </div>
      <div class="text-2xl font-bold text-primary mb-1" id="profile-stat-projects">--</div>
      <div class="text-xs text-muted uppercase tracking-wider">Total Projects</div>
    </div>

    <div class="stat-card text-center">
      <div class="stat-icon mx-auto mb-3"
           style="background:rgba(34,197,94,0.12);color:#4ade80;width:2.5rem;height:2.5rem;border-radius:0.75rem;display:flex;align-items:center;justify-content:center;">
        <i class="fas fa-clock"></i>
      </div>
      <div class="text-2xl font-bold text-primary mb-1" id="profile-stat-last-login">--</div>
      <div class="text-xs text-muted uppercase tracking-wider">Last Login</div>
    </div>

    <div class="stat-card text-center">
      <div class="stat-icon mx-auto mb-3"
           style="background:rgba(251,191,36,0.12);color:#fbbf24;width:2.5rem;height:2.5rem;border-radius:0.75rem;display:flex;align-items:center;justify-content:center;">
        <i class="fas fa-user-shield"></i>
      </div>
      <div class="mb-1">
        <span id="profile-stat-status" class="status-badge online" style="font-size:0.9rem;">Active</span>
      </div>
      <div class="text-xs text-muted uppercase tracking-wider">Account Status</div>
    </div>

  </div>

  <!-- ── Quick Actions ────────────────────────────────────── -->
  <div class="card mb-6" style="padding:1.5rem;">
    <h3 class="text-sm font-semibold uppercase tracking-wider text-muted mb-4">Quick Actions</h3>

    <div class="flex flex-wrap gap-3">

      <a
        href="/#create"
        class="btn btn-primary flex items-center gap-2 text-sm"
        onclick="event.preventDefault(); window.location.href='/'; setTimeout(()=>{if(window.App)App.showScreen('create');},200);"
      >
        <i class="fas fa-plus"></i>
        Create Project
      </a>

      <a
        href="/"
        class="btn btn-ghost flex items-center gap-2 text-sm"
      >
        <i class="fas fa-th-large"></i>
        Dashboard
      </a>

      <a
        href="/auth/logout"
        class="btn flex items-center gap-2 text-sm"
        style="border:1px solid rgba(239,68,68,0.4);color:#f87171;background:rgba(239,68,68,0.08);border-radius:0.5rem;padding:0.45rem 1rem;text-decoration:none;transition:all 0.2s;"
        onmouseover="this.style.background='rgba(239,68,68,0.18)'"
        onmouseout="this.style.background='rgba(239,68,68,0.08)'"
      >
        <i class="fas fa-sign-out-alt"></i>
        Sign Out
      </a>

    </div>
  </div>

  <!-- ── Preferences / Settings Summary ──────────────────── -->
  <div class="card" style="padding:1.5rem;">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-sm font-semibold uppercase tracking-wider text-muted">Preferences</h3>
      <a href="/"
         class="text-xs text-accent hover:underline"
         onclick="event.preventDefault();window.location.href='/';setTimeout(()=>{if(window.App)App.showScreen('settings');},200);">
        Edit in Settings <i class="fas fa-arrow-right ml-1"></i>
      </a>
    </div>

    <!-- Theme -->
    <div class="settings-row">
      <div>
        <div class="settings-label">Theme</div>
        <div class="settings-description">Current UI theme selection</div>
      </div>
      <span class="badge-indigo text-xs">Dark</span>
    </div>

    <!-- Editor Font Size -->
    <div class="settings-row">
      <div>
        <div class="settings-label">Editor Font Size</div>
        <div class="settings-description">Code editor font size</div>
      </div>
      <span
        id="profile-pref-fontsize"
        class="text-sm font-mono text-primary"
        style="padding:0.2rem 0.6rem;background:var(--bg-elevated);border-radius:0.375rem;border:1px solid var(--border);">
        14px
      </span>
    </div>

    <!-- Tab Size -->
    <div class="settings-row">
      <div>
        <div class="settings-label">Tab Size</div>
        <div class="settings-description">Indentation spaces per level</div>
      </div>
      <span
        id="profile-pref-tabsize"
        class="text-sm font-mono text-primary"
        style="padding:0.2rem 0.6rem;background:var(--bg-elevated);border-radius:0.375rem;border:1px solid var(--border);">
        4 spaces
      </span>
    </div>

    <!-- Word Wrap -->
    <div class="settings-row" style="border-bottom:none;">
      <div>
        <div class="settings-label">Word Wrap</div>
        <div class="settings-description">Wrap long lines in the editor</div>
      </div>
      <span id="profile-pref-wordwrap" class="badge-green text-xs">Enabled</span>
    </div>

  </div>

</div>

<script>
/* ── Profile page boot ──────────────────────────────────── */
(function () {
  function fmt(dateStr) {
    if (!dateStr) return '--';
    try {
      return new Date(dateStr).toLocaleDateString('en-US', {
        year: 'numeric', month: 'long', day: 'numeric'
      });
    } catch { return dateStr; }
  }

  function timeAgo(dateStr) {
    if (!dateStr) return '--';
    try {
      const diff = Math.floor((Date.now() - new Date(dateStr)) / 1000);
      if (diff < 60) return 'Just now';
      if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
      if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
      return Math.floor(diff / 86400) + 'd ago';
    } catch { return '--'; }
  }

  fetch('/auth/me')
    .then(r => r.ok ? r.json() : Promise.reject(r.status))
    .then(data => {
      const user = data.user || data;

      // Avatar
      const avatar = document.getElementById('profile-avatar');
      if (avatar && user.avatar_url) avatar.src = user.avatar_url;
      else if (avatar && user.name) {
        avatar.src = 'https://ui-avatars.com/api/?name=' +
          encodeURIComponent(user.name) +
          '&background=6366f1&color=fff&size=128';
      }

      // Identity
      const el = id => document.getElementById(id);
      if (el('profile-name')) el('profile-name').textContent = user.name || 'Unknown';
      if (el('profile-email')) el('profile-email').textContent = user.email || '--';
      if (el('profile-member-since'))
        el('profile-member-since').innerHTML =
          '<i class="fas fa-calendar-alt mr-1"></i>Member since ' + fmt(user.created_at);

      // Stats
      if (el('profile-stat-projects'))
        el('profile-stat-projects').textContent = user.project_count ?? '--';
      if (el('profile-stat-last-login'))
        el('profile-stat-last-login').textContent = timeAgo(user.last_login);

      // Preferences from localStorage (set by App.saveSettings)
      const s = JSON.parse(localStorage.getItem('llmca_settings') || '{}');
      if (el('profile-pref-fontsize'))
        el('profile-pref-fontsize').textContent = (s.fontSize || 14) + 'px';
      if (el('profile-pref-tabsize'))
        el('profile-pref-tabsize').textContent = (s.tabSize || 4) + ' spaces';
      if (el('profile-pref-wordwrap'))
        el('profile-pref-wordwrap').textContent =
          s.wordWrap === false ? 'Disabled' : 'Enabled';
      if (el('profile-pref-wordwrap') && s.wordWrap === false) {
        el('profile-pref-wordwrap').className = 'text-xs px-2 py-0.5 rounded-full';
        el('profile-pref-wordwrap').style.cssText =
          'background:rgba(239,68,68,0.12);color:#f87171;border:1px solid rgba(239,68,68,0.3);';
      }
    })
    .catch(err => {
      console.warn('Profile fetch failed:', err);
      // Graceful degradation — page still renders with placeholders
    });
})();
</script>
{% endblock %}
